<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>POINTAGE</title>
    <style>
       body {
    font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    background-color: #e0f2f1;
    margin: 0;
    padding: 0;
}

header {
    background-color: #004d40;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 28px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.container {
    max-width: 1600px;
    margin: 30px auto;
    padding: 20px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

th, td {
    border: 1px solid #b2dfdb;
    padding: 12px;
    text-align: center;
}

th {
    background-color: #047c68;
    color: white;
}

.highlight {
    background-color: #862f3c; /* Light red background */
    color: #f3f3f3; /* Dark red text color */
}

.edit-btn {
    background-color: #00796b;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s ease, transform 0.3s ease;
    margin-left: 40px;
}

.edit-btn:hover {
    background-color: #004d40;
    transform: scale(1.05);
}

.filter-input, .filter-select {
    width: calc(100% - 20px);
    padding: 10px;
    border: 1px solid #80cbc4;
    border-radius: 6px;
    margin-bottom: 0px;
    background-color: #f9fbe7;
    position: sticky;
}

.filter-select {
    background-color: #ffffff;
}

.totals {
    margin-bottom: 20px;
    padding: 10px 20px;
    background: linear-gradient(to right, #004d40, #00796b);
    color: white;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    text-align: center;
}

.total-item {
    margin-right: 20px;
    display: inline-block;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.total-item:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.total-item:last-child {
    margin-right: 0;
}

/* Style the dropdown button */
.dropbtn {
    background-color: #004d40;
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
}

/* Dropdown container */
.dropdown {
    position: fixed;
    display: inline-block;
}

/* Dropdown content (hidden by default) */
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #ffffff;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
    color: #000000;
    padding: 12px 16px;
    text-decoration: none;
    display: inline-block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd;}

/* Show the dropdown menu */
.dropdown:hover .dropdown-content {
    display: block;
}

/* Nested dropdown container */
.nested-dropdown {
    position: relative;
}

/* Nested dropdown button */


/* Nested dropdown content (hidden by default) */
.nested-dropdown-content {
    display: none;
    position: absolute;
    background-color: #ffffff;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 2;
}
.nested-dropbtn {
    background-color: #00796b;
    color: white;
    padding: 10px;
    font-size: 14px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
}
/* Show the nested dropdown content on hover */
.nested-dropdown:hover .nested-dropdown-content {
    display: block;
}

/* Links inside the nested dropdown */
.nested-dropdown-content a {
    color: #000000;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

/* Change color of nested dropdown links on hover */
.nested-dropdown-content a:hover {background-color: #ddd;}
/* WhatsApp Button */
.whatsapp-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #25D366;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 15px;
        cursor: pointer;
        z-index: 1000;
        transition: background-color 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .whatsapp-btn img {
        width: 40px;
        height: 40px;
    }

    .whatsapp-btn:hover {
        background-color: #128C7E;
    }

    /* Modal */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-content h2 {
        margin-top: 0;
        color: #004d40;
    }

    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #004d40;
    }
    
    select, input[type="date"], textarea,input {
        width: 100%;
        padding: 12px;
        margin-bottom: 5px;
        border: 1px solid #004d40;
        border-radius: 40px;
        box-sizing: border-box;
        font-size: medium;
        font-weight:bold ;
        background-color: #f3f0f0;
        text-align: center;
    }

    .BT11 {
        background-color: #004d40;
        color: #ffffff;
        padding: 12px;
        border: none;
        border-radius: 40px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        width: 100%;
    }

    textarea {
        resize: vertical;
    }

    .checkbox-group {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        border-radius: 60px;
    }

    .checkbox-group label {
        font-weight:bold ;
    }
 

    #downloadBtn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #04090f; /* يمكنك تغيير اللون هنا */
        color: rgb(156, 4, 4);
        border: none;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
    }

    #downloadBtn:hover {
        background-color: #0056b3; /* لون الخلفية عند التمرير */
    }
    
    </style>
</head>
<body>
  <button id="downloadBtn">
    &#128190; <!-- رمز القرص الصلب، يمكنك تغييره حسب رغبتك -->
</button>
    <div class="dropdown">
        <button class="dropbtn">MENU</button>
        <div class="dropdown-content" id="dayDropdown">
            <a href="#"></a>
            <a href="#">Pointage manuel</a>
            <a href="https://193.56.164.133:8443/reportes/Reporte/?key=Partes_Rendimientos">Rendement</a>
            <a href="https://193.56.164.133:8443/reportes/Reporte/?key=Marcheting">Rendement de tracteur</a>
            <a href="https://193.56.164.133:8443/ControlRoute/task/">Access Taches</a>
            <a href="https://193.56.164.133:8443/Tareo/productivity_log/">productivite</a>
            <a href="https://193.56.164.133:8443/Tareo/machinerymarking/">Modifier rnd tracteur</a>
            <div class="nested-dropdown">
      
                <option class="nested-dropbtn">JOUR   >></option>
                <div class="nested-dropdown-content">
                    <a href="https://aromaherbex.github.io/LUNDI/">LUNDI</a>
                    <a href="https://aromaherbex.github.io/MARDI/">MARDI</a>
                    <a href="https://aromaherbex.github.io/MERCREDI/">MERCREDI</a>
                    <a href="https://aromaherbex.github.io/JEUDI/">JEUDI</a>
                    <a href="https://aromaherbex.github.io/VENDREDI/">VENDREDI</a>
                    <a href="https://aromaherbex.github.io/SAMEDI/">SAMEDI</a>
                    <a href="https://aromaherbex.github.io/DIMANCHE/">DIMANCHE</a>
                </div>
            </div>
        </div>
      </div>
     
<div class="container">
   
<div class="totals">
    <span class="total-item">TOTAL H AGROTAREO: <span id="totalColumn4">0</span></span>
    <span class="total-item">TOTAL H POINTAGE: <span id="totalColumn5">0</span></span>

</div>

<table id="dataTable">
    <thead>
        <tr>
            <th><input type="text" class="filter-input" placeholder="MATRICULE"></th>
            <th><input type="text" class="filter-input" placeholder="NOMBRE"></th>
            <th><input type="text" class="filter-input" placeholder="EQUIPE"></th>
            <th><input type="text" class="filter-input" placeholder="AGROTAREO"></th>
            <th><input type="text" class="filter-input" placeholder="RHHH"></th>
            <th>
                <input type="text" class="filter-input" placeholder="DIFFERENCE">
                
            </th>
            
        </tr>
    </thead>
    <tbody>
        <!-- Data will be loaded here -->
    </tbody>
</table>
<div class="whatsapp-btn" onclick="openModal()">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/2048px-WhatsApp.svg.png" alt="WhatsApp">
</div>
<div class="wbtn" onclick="RENDEMENT()">RENDEMENT</div>
<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Envoyer des informations</h2>
      <form id="modalForm">
          <label for="dateModal">FINCA :</label>
          <input type="text" id="finca11" readonly/>
          <label for="dateModal">DATE :</label>
          <input type="text" id="date11" readonly>
          <label for="dateModal">TOTAL H :</label>
          <input type="text" id="heur" readonly/>
          <label for="dateModal">NOMBRE DE PRS :</label>
          <input type="text" id="prs" readonly/>
          <div class="checkbox-group">
              <label><input type="checkbox" id="person1Modal" name="destinataire" value="person1"> HICHAM</label>
              <label><input type="checkbox" id="person2Modal" name="destinataire" value="person2"> IBRAHIM</label>
          </div>
          
          
          <label for="messageModal">Message :</label>
          <textarea id="messageModal" name="message" rows="4" required></textarea>
       
          <button type="button11" class="BT11" onclick="sendToWhatsApp()">Envoyer sur WhatsApp</button>
      </form>
  </div>
</div>
<script>


    // URL of the Google Apps Script web app
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxKTqKvLcej8bGQKraPJf0xgXRTXJVPZuCLzQILPc1XqERSH08ThtKckEmclCANa40/exec';

    // Function to format date to YYYY-MM-DD
    function formatDate(dateString) {
        const dateObj = new Date(dateString);
        const day = dateObj.getDate();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        return `${year}-${month}-${day}`;
    }

    // Function to update totals and difference
    function updateTotals() {
    const table = document.getElementById('dataTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    
    let totalColumn4 = 0;
    let totalColumn5 = 0;

    Array.from(rows).forEach(row => {
        if (row.style.display !== 'none') { // Only include visible rows
            const cell4 = row.getElementsByTagName('td')[3]; // 4th column (index 3)
            const cell5 = row.getElementsByTagName('td')[3]; // 5th column (index 4)

            if (cell4) {
                totalColumn4 += parseFloat(cell4.textContent) || 0;
            }
            if (cell5 && parseFloat(cell5.textContent) > 0) { // Count only if value > 0
                totalColumn5++;
            }
        }
    });
    var finca1 = table.rows[3].cells[4].innerText;
      var date1 = table.rows[3].cells[5].innerText;
  

    document.getElementById('totalColumn4').textContent = totalColumn4.toFixed(1) + " H";
    document.getElementById('totalColumn5').textContent = totalColumn5 + " PRS"; // Display the row count where value > 0
    document.getElementById('heur').value = totalColumn4.toFixed(1) + " H";
    document.getElementById('prs').value = totalColumn4.toFixed(1) + " PRS";
    finca11.value = `${finca1}`;
    date11.value = `${date1}`;
      window.onload=updateTotals;
}



    // Fetch data from Google Sheets
    fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
            console.log('Data fetched successfully:', data); // Log the fetched data

            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];

            // Clear existing rows if any
            tableBody.innerHTML = '';

            data.forEach(row => {
                const newRow = tableBody.insertRow();

                Object.keys(row).forEach((key, index) => {
                    const cell = newRow.insertCell(index);
                    let cellValue = row[key];

                    // Format date in column 8
                    if (index === 5) { 
                        cellValue = formatDate(cellValue);
                    }

                    cell.textContent = cellValue;

                    // Apply red color if value in column 6 is not zero
                    

                    // If this is column 6 and its value is not 0, add the Edit button
                    if (index === 3 && parseInt(row[key], 10) > 0) {
                        const editButton = document.createElement("button");
                        editButton.textContent = "Modifier";
                        editButton.classList.add("edit-btn");
                        editButton.onclick = function() {
                            const cell1Value = newRow.cells[0].textContent.trim();
                            const cell2Value = newRow.cells[5].textContent.trim();
                            const url = `https://193.56.164.133:8443/ControlRoute/task/?q=${encodeURIComponent(cell1Value)}&initialValidate__range__gte=${encodeURIComponent(cell2Value)}&initialValidate__range__lte=${encodeURIComponent(cell2Value)}`;
                            window.location.href = url;
                        };
                        cell.appendChild(editButton);
                    }
                });
            });

            // Update totals after data is loaded
            updateTotals();

            // Add event listeners to filter inputs
            const filterInputs = document.querySelectorAll('.filter-input');
            filterInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    filterTable(index, input.value);
                });
            });

            // Add event listener to filter select
            const column6Filter = document.getElementById('column6Filter');
            column6Filter.addEventListener('change', () => {
                filterByValue(column6Filter.value);
            });
        })
        .catch(error => console.error('Error fetching data:', error));

    // Function to filter the table based on column and value
    function filterTable(columnIndex, filterValue) {
        const table = document.getElementById('dataTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            const cell = row.getElementsByTagName('td')[columnIndex];
            if (cell) {
                const cellValue = cell.textContent.toLowerCase();
                const isVisible = columnIndex === 5 
                    ? (filterValue === 'less' ? parseInt(cellValue, 10) < 0 : filterValue === 'greater' ? parseInt(cellValue, 10) > 0 : cellValue.includes(filterValue.toLowerCase()))
                    : cellValue.includes(filterValue.toLowerCase());

                row.style.display = isVisible ? '' : 'none';
            }
        });

        // Update totals after filtering
        updateTotals();
    }

    // Function to filter rows based on column 6 value
    function filterByValue(condition) {
        const table = document.getElementById('dataTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            const cell = row.getElementsByTagName('td')[5]; // Column 6 (0-based index 5)
            if (cell) {
                const cellValue = parseFloat(cell.textContent) || 0;
                const isVisible = condition === 'less' ? cellValue < 0 : condition === 'greater' ? cellValue > 0 : true;
                row.style.display = isVisible ? '' : 'none';
            }
        });

        // Update totals after filtering
        updateTotals();
    }

    function openModal() {
        document.getElementById("myModal").style.display = "block";
    }

    // Close the modal
    function closeModal() {
        document.getElementById("myModal").style.display = "none";
    }

    // Send message via WhatsApp
    function sendToWhatsApp() {
        var finca11 = document.getElementById("finca11").value;
        var date11 = document.getElementById("date11").value;
        var message = document.getElementById("messageModal").value;
        var prs = document.getElementById("prs").value;
        var heur = document.getElementById("heur").value;
        
        var phoneNumbers = [];
        if (document.getElementById("person1Modal").checked) {
            phoneNumbers.push("+212662781207"); // Numéro de téléphone pour la personne 1
        }
        if (document.getElementById("person2Modal").checked) {
            phoneNumbers.push("+212663715065"); // Numéro de téléphone pour la personne 2
        }

        var fullMessage = `FINCA : *${finca11}*\n\nDATE : *${date11}*\n\nTOTAL H :*${heur}*\n\nNOMBRE DE PRS : *${prs}* \n\nle nombre d'heures est correct\n\n*(${message})*`;

        if (phoneNumbers.length > 0) {
            for (var i = 0; i < phoneNumbers.length; i++) {
                (function(i) {
                    setTimeout(function() {
                        var whatsappURL = `https://wa.me/${phoneNumbers[i]}?text=${encodeURIComponent(fullMessage)}`;
                        window.open(whatsappURL, '_blank');
                    }, i * 1000); // Délai de 1 seconde entre chaque envoi
                })(i);
            }
            // Clear the form after sending
            document.getElementById("modalForm").reset();
            closeModal(); // Close the modal after sending
        } else {
            alert("Veuillez sélectionner au moins une personne.");
        }
    }
    document.getElementById('downloadBtn').addEventListener('click', function () {
    // تحديد الجدول من HTML
    var table = document.getElementById('dataTable');
    
    // الحصول على القيمة من الخلية في العمود 6 من الصف الأول
    var fileName = table.rows[2].cells[5].innerText || 'default_name';  

    // إنشاء الكتاب
    var wb = XLSX.utils.table_to_book(table, {sheet: "POINTAGE F20"});
    var wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});

    function s2ab(s) { 
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;    
    }

    // إنشاء Blob وتحميل الملف
    var blob = new Blob([s2ab(wbout)], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    var url = URL.createObjectURL(blob);
    var downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = fileName + '.xlsx';  
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
